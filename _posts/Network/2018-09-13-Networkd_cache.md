---
layout: post
title: "캐시"
date: 2018-03-19  00:00:00
img:
tags: [network]
---
> HTTP 완벽 가이드 책 정리

---

## 캐시

### 캐시 혜택
1. 불필요한 데이터 전송을 줄여, 네트워크 요금으로 인한 비용을 줄여준다.
2. 캐시는 네트워크 병목을 줄여준다. 대역폭을 늘리지 않고 페이지를 빨리 불러온다.
3. 원 서버에 대한 요청을 줄여준다. 서버 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 한다.
4. 페이지를 먼 곳에서 불러올수록 시간이 많이 걸리는데 캐시는 거리로 인한 지연을 줄여준다.

## 7.1 불필요한 데이터 전송
서버 응답은 캐시에 보관된다. 캐시된 사본이 뒤이은 요청들에 대한 응답으로 사용될 수 있기 때문에, 원 서버가 중복해서 트래픽을 주고 받는 낭비를 줄이게 된다.

## 7.2 대역폭 병목
캐시 또한 네트워크 병목을 줄여준다. 많은 네트워크가 원격 서버보다 로컬 네트워크 클라이언트에 더 넓은 대역폭을 제공한다. 대역폭은 네트워크 속도와 문서 크기에 따라 전송 시간에 얼마나 영향을 주는지 볼 수 있다. 대역폭은 큰 문서에 대해 현저한 지연을 일으키며 속도는 네트워크 종류의 차이에 따라 극적으로 달라진다. ex) 이더넷 LAN > DS3 > 느린 이더넷 > TI > DSL > 전화식 모뎀

## 7.3 갑작스런 요청 쇄도(Flash Crowds)
갑작스런 요청 쇄도에 대처하기 위해 캐싱은 중요하다. 많은 사람이 겅의 동시에 웹 문서에 접근 할때 이런 일이 발생된다. 그 결과 불필요한 트래픽 급증은 네트워크와 웹 서버의 심각한 장애를 야기시킨다.

## 7.4 거리로 인한 지연
대역폭이 문제가 되지 않더라도, 거리가 문제가 될 수 있다. 모든 네트워크 라우터는 제각각 인터넷 트래픽을 지연시킨다. 그리고 클라이언트와 서버 사이에 라우터가 그다지 많지 않아도 빛의 속도 그 자체가 유의미한 지연을 유발한다. <br>
기계실 근처에 캐시를 설치해서 문서가 전송되는 거리를 수천 킬로미터에서 수십미터로 줄일 수 있다.

## 7.5 적중과 부적중
캐시는 모듬 문서의 사본을 저장하지 않는다. 캐시에 요청이 도착했을 때, 사본이 있다면 그를 이용해 요청을 처리 할 수 있다. 이것을 **캐시 적중(cache hit)** 이라고 한다. 만약 사본이 없이 원 서버로 전달되면 **캐시 부적중(cache miss)** 라고 한다.

### 7.5.1 재검사(Revalidaton)
원 서버 콘텐츠는 변경 될 수 있기 때문에, 캐시는 반드시 그들이 갖고 있는 사본이 여전히 최신인지 서버를 통해 때대로 점검해야 한다. 이를 **신선도 검사** 혹은 **재검사**라 한다. HTTP 는 서버로부터 전체 객체를 가져오지 않고도 콘텐츠가 여전히 신썬한지 빠르게 검사할 수 잇는 특별한 요청을 정의했다. 캐시는 스스로 원한다면 언제든지 사본을 재검사 할 수 있다. 그러나 많은 양의 경우 네트워크 대역폭은 부하기 대문에 그 사본이 검사를 할 필요가 있을 정도로 충분히 오래된 경우에만 재검사를 한다. <br>
콘텐츠가 변경되지 않았다면, 서버는 아주 작은 **304 Not Modified** 응답을 보낸다.
- **재검사 적중**/**느린 적중** : 그 사본이 여전히 유효함을 알게된 캐시는 즉각 사본이 신선하다고 임시로 다시 표시한 뒤 그 사본을 클라이언트에 제공한다. 이는 순수 캐시 적중보다 느린데, 원 서버와 검사를 필요가 있기 때문이다. 그러나 캐시 부적중 보다는 빠른데, 서버로부터 캑체 데이터를 받아올 필요가 없기 때문이다. 정리, **순수 캐시 적중 > 재검사 적중 > 캐시 부적중**

- **If-Modified-Since** : 서버에게 보내는 GET 요청에 이 헤더를 추가하면, 캐시된 시간 이후에 변경된 경우에만 사본을 보내달라는 의미
    - 서버 콘텐츠가 변경되지 않은 경우 : 서버 객체가 변경되지 않았다면, **304 Not Modified** 응답을 보냄
    - 서버 콘텐츠가 변경된 경우 : 사본과 다른 경우 서버는 콘텐츠 전체와 함께 평범한 **200 OK** 응답을 보냄
    - 객체가 삭제된 경우 : 삭제된 경우 **404 Not Found** 응답을 보냄 그리고 캐시 사본을 삭제

### 7.5.2 적중률
캐시가 요청을 처리하는 비율을 **캐시 적중률** 또는 **문서 적중률**이라고 한다. 적중률은 0에서 1까지의 값으로 흔히 퍼ㅔㄴ트로 표현된다. 0%는 모든 요청이 부적중(네트워크 너머로 문서를 가져와야 하는 경우) 그리고 100% 모든 요청이 캐시 적중(캐시에서 사본 가져오는 것)을 의미한다. <br>
적중률은 예측하기 어려우나 40% 면 웹캐시로 괜찮은 편이다. 보통 크기의 캐시라도 충분한 분량의 자주 쓰이는 무서들을 보관하여 상당한 트래픽을 줄이고 성능을 개선할 수 있다. 캐시는 유용한 콘텐츠가 캐시안에 머무르도록 보장하기 위해 노력한다.

### 7.5.3 바이트 적중률
바이트 단위 적중률은 캐시를 통해 제공된 모든 바이트의 비율을 표현한다. 이 측정값은 트래픽이 저감된 정도를 포착해낸다. 바이트 단위 적중률 100%는 모든 바이트가 캐시에서 왔으며, 어떤 트래픽도 인터넷으로 나가지 않았음을 의미한다. <br>
트랜잭션은 고정된 소요 시간을 포함하게 되는데, 바이트 단위 적중률은 얼마나 많은 바이트가 인터넷으로 나가지 않았는지 보여준다. 바이트 단위 적중률의 개선은 대역폭 절약을 최적화 한다.

### 7.5.4 적중과 부적중의 구별
HTTP는 클라이언트에게 응답이 캐시 적중이었는지 아니면 원 서버 접근인지 말해 줈수 있는 방법을 제공하지 않는다. 두 경우 응답 코드는 본문을 갖고 있음을 의미하는 200 OK 가 될것이다. <br>
클라이언트라 응답이 캐시에서 왔는지 알아내는 방법은 첫째, Date 헤더를 이용하는 것이다. 응답의 Date 헤더 값ㅅ을 현재 시각과 비교하여, 응답의 생성일을 더 오래되었다면 클라이언트의 응답이 캐시된 것임을 알 수 있다. 둘재, 응답이 얼마나 오래되었는지 말해주는 Age 헤더를 이용하는 것이다.

## 7.6 캐시 토폴로지
캐시는 한 명에게만 할당되는 **개인 전용 캐시** 가 있는데 이는 한 명의 사용자가 자주 찾는 페이지를 담는다. 공유된 캐시는 **공용 캐시** 라고 하며 사용자 집단에게 자주 쓰이는 페이지를 담는다.

### 7.6.1 개인 전용 캐시
개인 전용 캐시는 많은 에너지나 저장 공간을 필요로 하지 않으므로 작고 저렴할 수 있다. 웹르아우저는 개인 전용 캐시를 내장하고 있다. 대부분의 브라우저는 자주 쓰이는 문서를 개인용 컴퓨터의 디스크와 메모리에 캐시해 놓고, 사용자가 캐시 사이즈와 설정을 수정할 수 있도록 허용한다. 또한 캐시에 어떤 것들이 있는지 확인하기 위해 브라우저 안을 드여다보는 것도 가능하다.

### 7.6.2 공용 프락시 캐시
공용 캐시는 캐시 프락시 서버 혹은 프락시 캐시라고 불리는 특별한 종류의 공유된 프라시 서버다. 프락시 캐시는 로컬 캐시에서 무서를 제공하거나 사용자의 입장에서 서버에 적근한다. 공요캐시에는 여러 사용자가 접근하기 때문에, 불필요한 트래픽을 줄 일 수 있는 더 많은 기회가 있다. <br>
각 개인 전용 캐시는 같은 문서를 네트워크를 거쳐 여러 번 가져온다. 그러나 공유된 공유 캐시에서 , 캐시는 자주 찾는 객체를 단 한번 만 가져와 모든 요청에 대해 공유된 사본을 제공함으로써 네트워크 트래픽을 줄인다.  <br>
프락시 캐시는 프락시를 위한 규칙을 따르며 수동 프락시, 프락시 자동설정 파일을 설정하여 브라우저가 프락시 캐시를 사용하도록 설정할 수 있다.

### 7.6.3 프락시 캐시 계층들
작은 캐시에서 캐시 부적중이 발생했을 때, 더 큰 무보 캐시가 그 걸려 남겨진 트래픽을 처리하도록 하는 계측을 만드는 방식이 합리적인 경우가 많다. 클라이언트 주위에 작고 저렴한 캐시를 사용하고 계층 상단에는 많은 사용자들에 의해 공유되는 문서를 유지하기 위해 더 크고 강력한 캐시를 사용하자는 것이다. 물론 캐시 계층이 깊다면 요청은 캐시의 긴 연쇄를 따라가게 될 것이며, 길어질수록 중간 프랒시는 현저한 성능 저하가 발생할 것이다.

### 7.6.4 캐시망, 콘텐츠 라우팅, 피어링
캐시망의 프락시 캐시는 복잡한 방법으로 서로 대화하며, 어떤 부모 캐시와 대화할것인지 아니면 요청이 캐시를 완전히 우회해서 원 서버로 바로 가도록 할것인지에 대해 캐시 커뮤니케이션 결정을 동적으로 내린다.
- URL에 근거하여, 부모 캐시와 원 서버 중 하나를 동적으로 선택
- URL 에 근거하여 특정 부모 캐시를 동적으로 선택
- 부모 캐시에게 가기전, 캐시된 사본을 로컬에서 찾아본다.
- 다른 캐시들이 그들의 캐시된 콘텐츠에 부분적으로 접근할 수 있또록 허용하되, 그들의 캐시를 통한 인터넷 트렌짓은 허용하지 않는다.
<br>
서로 다른 조직들이 상호 이득을 위해 그들의 캐시를 연결하여 서로를 찾아볼 수 있도록 해주며, 선택적인 피어링을 지원하는 캐시는 형제 캐시라고 한다. HTTP는 형제 ㅐ시를 지원하지 않기 때문에, 인터넷 캐시 프로토콜(ICP)나 하이퍼텍스트 캐시 프로토콜을 이용해 HTTP를 확장했다.

## 7.7 캐시 처리 단계
HTTP GET 메시지 하나를 처리하는 기본적인 캐리 처리 절차는 일곱 단계로 이루어져있다.
1. 요청받기 - 키시는 네트워크로부터 도착한 요청 메시지를 읽는다.
2. 파싱 - 메시지를 파싱하여 URL과 헤더들을 추출한다.
3. 검색 - 캐시는 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아온다. (그리고 로컬에 저장)
4. 신선도 검사 - 캐시는 캐시된 사보이 충분히 신선한지 검사하고, 신선하지 않다면 변경사항이 있는지 서버에 물어본다.
5. 응답 생성 - 캐시는 새로운 헤더와 캐시된 본문으로 응답 메시지를 만든다.
6. 발송 - 캐시는 네트워크를 통해 응답을 클라이언트에게 돌려준다.
7. 로깅 - 선택적으로, 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남긴다.
